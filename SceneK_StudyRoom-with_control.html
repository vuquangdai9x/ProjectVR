<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Director Room Abstract</title>

<!-- 	<script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
	<script src="https://unpkg.com/aframe-event-set-component/dist/aframe-event-set-component.min.js"></script> 
	<script src="https://recast-api.donmccurdy.com/aframe-inspector-plugin-recast.js"></script>  -->
	
	<script src="js/aframe.min.js"></script>
	<script src="js/aframe-extras.min.js"></script>
	<script src="js/aframe-event-set-component.min.js"></script>

	<link rel="stylesheet" href="css/control-scene.css">
</head>
<body>
	<script type="text/javascript">
		AFRAME.registerComponent('update-shadowmap-when-loaded', {
			init: function () {
				var _self = this;
				this.el.addEventListener('loaded', function () {
					console.log("loaded");
					_self.el.sceneEl.renderer.shadowMap.needsUpdate = true;
				});
				this.el.addEventListener('model-loaded', function () {
					console.log("model-loaded");
					_self.el.sceneEl.renderer.shadowMap.needsUpdate = true;
				});
			},
		});

		AFRAME.registerComponent('update-shadowmap-on-change-prop', {
			init: function () {
				var _self = this;
				this.el.addEventListener('componentchanged', function () {
					_self.el.sceneEl.renderer.shadowMap.needsUpdate = true;
				});
			},
		});

		AFRAME.registerComponent('click-to-toggle-light', {
			schema: {
				lightOn: {type: 'boolean', default: true},
				targetLight: {type: 'selector'},
				colorWhenLightOn: {type: 'color', default: '#fff'},
				colorWhenLightOff: {type: 'color', default: '#777'}
			},
			init: function () {
				var _self = this;
				let isLightOn = this.data.lightOn;
				this.data.targetLight.setAttribute("visible", isLightOn);
				_self.el.setAttribute("material", {
					'color': (isLightOn?_self.data.colorWhenLightOn:_self.data.colorWhenLightOff)
				});
				this.el.addEventListener('click', function () {
					let isLightOn = !_self.data.lightOn;
					_self.data.lightOn = isLightOn;
					_self.data.targetLight.setAttribute("visible", isLightOn);
					_self.el.setAttribute("material", {
						'color': (isLightOn?_self.data.colorWhenLightOn:_self.data.colorWhenLightOff)
					});
				});
			},
		});
	</script>
	<!-- <div id="main"> -->
		<div id="SceneView">
			<div id="SettingUI">
				<h1>Phòng học</h1>
				<h2>Tùy chỉnh thời gian</h2>
				<div id="ListTimeItems">
					<button class="TimeItem custom-button" onclick="setTime(7500)">Sáng</button>
					<button class="TimeItem custom-button" onclick="setTime(15000)">Chiều</button>
					<button class="TimeItem custom-button" onclick="setTime(20000)">Tối</button>
				</div>
				<input type="time" name="time-info" id="InputTime" class="custom-button" onchange="setTime(this.value)">
				<input type="range" name="time-info-range" id="InputTimeSlider" min="1" max="23999" class="custom-button" onchange="setTime(this.value)" oninput="setTime(this.value, true)">
				<h2>Chọn kịch bản</h2>
				<div id="ListScenario">
					<button class="ScenarioItem custom-button">Tiếp khách</button>
					<button class="ScenarioItem custom-button">Không có người</button>
					<button class="ScenarioItem custom-button">Phòng đông người</button>
				</div>
			</div>
			<div id="SceneContainer">
				<!-- <a-scene scene_init stats shadow="type: pcfsoft" inspector-plugin-recast > -->
				<!-- <a-scene scene_init stats shadow="type: pcfsoft" embedded> -->
				<a-scene scene_init embedded shadow="type: pcfsoft; autoUpdate: false;">
					<a-assets>
						<a-asset-item id="walkMesh" src="resources/model/study-room-01/nav-mesh-livingroom-01.gltf"></a-asset-item>
						<img id="skysphere_seashore" src="resources/textures/Above_the_sea.jpg"/>
						<img id="seemless_wall" src="resources/textures/seamless-wall-white.jpg"/>
						<a-mixin id="wall" material="roughness: 1.0;" shadow="cast: false"></a-mixin>
						<a-asset-item id="roomBox" src="resources/model/study-room-01/LivingRoom-01(packed).gltf" update-shadowmap-when-loaded></a-asset-item>
					</a-assets>

					<a-sky id="sky" src="#skysphere_seashore" ></a-sky>
					<a-entity id="walkMesh" gltf-model="#walkMesh" nav-mesh visible="false"></a-entity>
					<a-entity id="rig" movement-controls="constrainToNavMesh: true">
						<a-entity camera position="0 1.2 0" look-controls="pointerLockEnabled: true">
							<a-cursor position="0 0 -0.1" scale="0.1 0.1 0.1" raycaster="objects: .gaze-listener"></a-cursor>
							<!-- <a-entity position="-0.2 -0.2 -0.2" laser-controls="hand: left" raycaster="objects: .laser-listener; showLine: true; far: 2" line="color: red; opacity: 0.75" ex-keyboard-controls="enabled: false"></a-entity> -->
						</a-entity>
						<!-- <a-entity hand-controls="hand: left" ex-keyboard-controls="enabled: false" control-laser-by-keyboard></a-entity> -->
					</a-entity>
					<!-- <a-sphere id="raycast-intersection-point" radius="0.1"></a-sphere> -->

					<!-- room wall -->
					<a-entity gltf-model="#roomBox" position="0 0 0" shadow update-shadowmap-when-loaded></a-entity>

					<!-- light -->
					<a-entity light="type: ambient; color: #BBB; intensity: 0.2;"></a-entity>
					<a-entity id="sunLight" light="type: directional; castShadow: true; shadowBias: -0.001; shadowCameraFar: 50; shadowRadius: 0; shadowCameraTop: 10; shadowCameraRight: 10; shadowCameraBottom: -10; shadowCameraLeft: -10;" position="0 10 10" rotation="0 0 0" target="#directionaltarget" update-shadowmap-on-change-prop shadow update-shadowmap-when-loaded></a-entity>
					<a-entity id="directionaltarget" position="0 0 0" visible="false"></a-entity>
					<a-entity light="type: point" rotation="90 0 0" visible="" position="0 1.2 2.5"></a-entity>
				</a-scene>
			</div>
		</div>
		<div id="ListScene">
			<h2 id="ListSceneTitle">Danh sách các phòng:</h2>
			<div id="ListSceneItem">
				<a href="SceneH_LivingRoom-with_control.html" class="SceneItem custom-button">Phòng khách</a>
				<a href="SceneK_StudyRoom-with_control.html" class="SceneItem custom-button">Phòng học</a>
			</div>
		</div>
	<!-- </div> -->

	<script type="text/javascript">
		var timeInput = document.getElementById("InputTime");
		var timeInputSlider = document.getElementById("InputTimeSlider");
		var scene = document.querySelector('a-scene');
		var lightEntity;

		var time_scenario = {
			"sun": {
				"general": {
					"sun_distance": 10.0,
					"sun_delta_phi": 120.0,
					"timeline": [
						{
							'time': 0,
							'angle': -90,
							'visible': true,
							'color': '#2e46ff'
						},
						{
							'time': 4500,
							'angle': 0,
							'visible': true,
							'color': '#000'
						},
						{
							'time': 6000,
							'angle': 20,
							'visible': true,
							'color': '#491c03'
						},
						{
							'time': 12000,
							'angle': 90,
							'visible': true,
							'color': '#fff4d6'
						},
						{
							'time': 17000,
							'angle': 160,
							'visible': true,
							'color': '#491c03'
						},
						{
							'time': 19000,
							'angle': 180,
							'visible': true,
							'color': '#000'
						}
					]
				},
				"summer": {}
			}
		};

		function lerpColor(a, b, amount) { 
			var ah = parseInt(a.replace(/#/g, ''), 16),
				ar = ah >> 16, ag = ah >> 8 & 0xff, ab = ah & 0xff,
				bh = parseInt(b.replace(/#/g, ''), 16),
				br = bh >> 16, bg = bh >> 8 & 0xff, bb = bh & 0xff,
				rr = ar + amount * (br - ar),
				rg = ag + amount * (bg - ag),
				rb = ab + amount * (bb - ab);
			return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
		}

		function setTime(time, updateScene = true){
			if (!isNaN(time))
			{
				var hour = parseInt(parseInt(time) / 1000);
				var minute = parseInt(parseInt(time-hour*1000) * 60 / 1000);
				if (hour < 10){
					hour = "0"+hour;
				}
				if (minute < 10){
					minute = "0"+minute;
				}
				timeInput.value = hour + ":" + minute + ":00";
				timeInputSlider.value = time;
			}else if (time.match(/^\d{1,2}(:\d{1,2}){1,2}$/)){
				timeInput.value = time;
				let time_splitted = time.split(":", 3);
				time = parseInt(time_splitted[0])*1000+parseInt(time_splitted[1])*1000/60;
				timeInputSlider.value = time;
			}

			if (updateScene){
				if (lightEntity){
					let r = time_scenario.sun.general.sun_distance;
					let phi = time_scenario.sun.general.sun_delta_phi * Math.PI / 180.0;

					var angle, isVisible, color;
					var timelineArray = time_scenario.sun.general.timeline;
					if (timelineArray.length == 0){
						angle = parseFloat((time-6000)%24000) * 2.0 * Math.PI / 24000.0;
					}else if (timelineArray.length == 1){
						angle = timelineArray[0].angle;
						isVisible = timelineArray[0].visible;
						color = timelineArray[0].color;
					}else{
						var timePointPrev, timePointNext, lerpValue;
						if (time <= timelineArray[0].time){
							timePointPrev = timelineArray[timelineArray.length-1];
							timePointNext = timelineArray[0];
							lerpValue = (time-(timePointPrev.time-24000))/(timePointNext.time-timePointPrev.time);
						}else if (time >= timelineArray[timelineArray.length-1].time){
							timePointPrev = timelineArray[timelineArray.length-1];
							timePointNext = timelineArray[0];
							lerpValue = (time-timePointPrev.time)/(timePointNext.time+24000-timePointPrev.time);
						}else{
							for(var i = 1; i < timelineArray.length; i++) {
								if (time <= timelineArray[i].time){
									timePointPrev = timelineArray[i-1];
									timePointNext = timelineArray[i];
									lerpValue = (time-timePointPrev.time)/(timePointNext.time-timePointPrev.time);
									break;
								}
							}
						}

						// TODO: need to fix angle calculation
						let deltaAngle = timePointNext.angle-timePointPrev.angle;
						if (timePointNext.angle < 0){
							deltaAngle = timePointNext.angle + 360 - timePointPrev.angle;
						}
						angle = timePointPrev.angle + deltaAngle*lerpValue;
						angle = angle * Math.PI / 180.0;
						visible = timePointPrev.visible && timePointNext.visible;
						color = lerpColor(timePointPrev.color, timePointNext.color, lerpValue);
					}

					let posY = r * Math.sin(angle);
					let posZ = r * Math.cos(angle) * Math.sin(phi);
					let posX = r * Math.cos(angle) * Math.cos(phi);
					lightEntity.setAttribute('position', {x: posX, y: posY, z: posZ});
					lightEntity.setAttribute('visible', visible);
					lightEntity.setAttribute('light', {'color':color});
				}
			}
		}

		

		if (scene.hasLoaded) {
			run();
		} else {
			scene.addEventListener('loaded', run);
		}

		function run () {
			lightEntity = scene.querySelector('#sunLight');
		}
	</script>
</body>
</html>
